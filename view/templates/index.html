<!DOCTYPE html>
<html>
<head>
  {% load staticfiles %}
  <link rel="stylesheet" href="{% static "view/bootstrap/css/bootstrap.css" %}">
  <link rel="stylesheet" href="{% static "view/bootstrap/css/bootstrap-theme.css" %}">
  <script src="{% static "view/jquery-1.11.0.min.js" %}"></script>
  <script src="{% static "view/bootstrap/js/bootstrap.js" %}"></script>
  <script src="{% static "view/d3/3.4.4/d3.js" %}"></script>
  <script src="{% static "view/dagre-d3/0.1.5/dagre-d3.js" %}"></script>
  <style>
    g.type-TK > rect {
      fill: #00ffd0;
    }

    svg {
      border: 1px solid #999;
      overflow: hidden;
    }

    text {
      font-weight: 300;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
      font-size: 14px;
    }

    .node rect {
      stroke: #999;
      stroke-width: 1px;
      fill: #fff;
    }

    .edgeLabel rect {
      fill: #fff;
    }

    .edgePath path {
      stroke: #333;
      stroke-width: 1.5px;
      fill: none;
    }
  </style>

  <style>
    .highlighted_entity {
      background-color: pink;
    }
    .highlighted_mention {
      background-color: yellow;
    }
  </style>

  <script>
   function getTokensForMentionID(comm, mentionId) {
   }

   function getTokenizationWithUUID(comm, uuid) {
   }


   $(document).ready(function() {
     $.getJSON("{% url 'as_json' %}", function(comm) {
       // Add tokens to DOM tree
       for (var sectionListIndex in comm.sectionSegmentations[0].sectionList) {
         for (var sentenceIndex in comm.sectionSegmentations[0].sectionList[sectionListIndex].sentenceSegmentation[0].sentenceList) {

           var sentence = comm.sectionSegmentations[0].sectionList[0].sentenceSegmentation[0].sentenceList[sentenceIndex];
           var sentence_div = $('<div/>')
                              .addClass('sentence')
                              .attr('id', 'tokenization_' + sentence.uuid);
           for (var tokenIndex in sentence.tokenizationList[0].tokenList) {
             var token = sentence.tokenizationList[0].tokenList[tokenIndex];
             var token_span = $('<span/>')
                                 .addClass('token')
                                 .html(" " + token.text + " ")
                                 .attr('id', 'tokenization_' + sentence.tokenizationList[0].uuid + "_" + token.tokenIndex);
             sentence_div.append(token_span);
           }
           $('#communication').append(sentence_div);
         }
       }

       // Add mentionId's to tokens
       for (var entityMentionSetIndex in comm.entityMentionSets) {
         for (var mentionSetIndex in comm.entityMentionSets[entityMentionSetIndex].mentionSet) {
           var mentionSet = comm.entityMentionSets[entityMentionSetIndex].mentionSet[mentionSetIndex];

           for (tokenIndex in mentionSet.tokens.tokenIndexList) {
             $('#tokenization_' + mentionSet.tokens.tokenizationId + '_' + mentionSet.tokens.tokenIndexList[tokenIndex])
                                               .addClass('mention')
                                               .addClass('mention_' + mentionSet.uuid);
           }
         }
       }

       // Add list of entities, and list of mentions for each entity, to the DOM
       for (var entityListIndex in comm.entitySets[0].entityList) {
         var entityList = comm.entitySets[0].entityList[entityListIndex];
         var entityList_div = $('<div/>')
                              .html('<span class="entity entity_' + entityList.uuid + '"><b>Entity:</b> ' + entityList.uuid + '</span>')
                              .attr('id', 'entity_' + entityList.uuid);
         var mentionId_ul = $('<ul/>');

         for (var mentionIdListIndex in entityList.mentionIdList) {
           var mentionId = entityList.mentionIdList[mentionIdListIndex];
           var mentionId_li = $('<li/>')
                                     .html('<span class="mention_' + mentionId + '">' + mentionId + '</span>');
           mentionId_ul.append(mentionId_li);

           // Add 'entity_ENTITY_UUID' class to each mention of that entity
           $('.mention_' + mentionId).addClass('entity_' + entityList.uuid);
         }
         entityList_div.append(mentionId_ul);

         $('#entityList').append(entityList_div);
       }

       // Add mouseover functions for all elements linked to an entity
       for (var entityListIndex in comm.entitySets[0].entityList) {
         $('.entity_' + entityList.uuid).mouseenter({ entity_selector: '.entity_' + entityList.uuid }, function(event) {
           $(event.data.entity_selector).addClass("highlighted_entity");
         }).mouseleave({ entity_selector: '.entity_' + entityList.uuid }, function(event) {
           $(event.data.entity_selector).removeClass("highlighted_entity");
         });
       }

       // Add mouseover functions for all elements linked to a mention
       for (var entityMentionSetIndex in comm.entityMentionSets) {
         for (var mentionSetIndex in comm.entityMentionSets[entityMentionSetIndex].mentionSet) {
           var mentionSet = comm.entityMentionSets[entityMentionSetIndex].mentionSet[mentionSetIndex];
           $('.mention_' + mentionSet.uuid).mouseenter({ mention_selector: '.mention_'+mentionSet.uuid }, function(event) {
             $(event.data.mention_selector).addClass("highlighted_mention");
           }).mouseleave({ mention_selector: '.mention_'+mentionSet.uuid }, function(event) {
             $(event.data.mention_selector).removeClass("highlighted_mention");
           });
         }
       }
     });
   });
  </script>
</head>
<body>
  <div class="container">

    <h1>Tree-tastic</h1>

    <div id="communication"></div>

    <div id="entityList"></div>

    <div id="attach">
      <svg id="svg-canvas" width=800 height=600>
        <g transform="translate(20, 20)"/>
      </svg>
    </div>

  </div>

  <script>
    var g = new dagreD3.Digraph();
    g.addNode(0,  { label: "TOP",       nodeclass: "type-TOP" });
    g.addNode(1,  { label: "S",         nodeclass: "type-S" });
    g.addNode(2,  { label: "NP",        nodeclass: "type-NP" });
    g.addNode(3,  { label: "DT",        nodeclass: "type-DT" });
    g.addNode(4,  { label: "This",      nodeclass: "type-TK" });
    g.addNode(5,  { label: "VP",        nodeclass: "type-VP" });
    g.addNode(6,  { label: "VBZ",       nodeclass: "type-VBZ" });
    g.addNode(7,  { label: "is",        nodeclass: "type-TK" });
    g.addNode(8,  { label: "NP",        nodeclass: "type-NP" });
    g.addNode(9,  { label: "DT",        nodeclass: "type-DT" });
    g.addNode(10, { label: "an",        nodeclass: "type-TK" });
    g.addNode(11, { label: "NN",        nodeclass: "type-NN" });
    g.addNode(12, { label: "example",   nodeclass: "type-TK" });
    g.addNode(13, { label: ".",         nodeclass: "type-." });
    g.addNode(14, { label: "sentence",  nodeclass: "type-TK" });

    g.addEdge(null, 3, 4);
    g.addEdge(null, 2, 3);
    g.addEdge(null, 1, 2);
    g.addEdge(null, 6, 7);
    g.addEdge(null, 5, 6);
    g.addEdge(null, 9, 10);
    g.addEdge(null, 8, 9);
    g.addEdge(null, 11,12);
    g.addEdge(null, 8, 11);
    g.addEdge(null, 5, 8);
    g.addEdge(null, 1, 5);
    g.addEdge(null, 13,14);
    g.addEdge(null, 1, 13);
    g.addEdge(null, 0, 1)

    var renderer = new dagreD3.Renderer();
    var oldDrawNodes = renderer.drawNodes();
    renderer.drawNodes(function(graph, root) {
      var svgNodes = oldDrawNodes(graph, root);
      svgNodes.each(function(u) {
        d3.select(this).classed(graph.node(u).nodeclass, true);
      });
      return svgNodes;
    });
    var layout = renderer.run(g, d3.select("svg g"));
    d3.select("svg")
      .attr("width", layout.graph().width + 40)
      .attr("height", layout.graph().height + 40);
  </script>

</body>
</html>
