<!DOCTYPE html>
<html>
<head>
  {% load staticfiles %}
  <link rel="stylesheet" href="{% static "view/bootstrap/css/bootstrap.css" %}">
  <link rel="stylesheet" href="{% static "view/bootstrap/css/bootstrap-theme.css" %}">
  <script src="{% static "view/jquery-1.11.0.min.js" %}"></script>
  <script src="{% static "view/bootstrap/js/bootstrap.js" %}"></script>
  <script src="{% static "view/d3/3.4.4/d3.js" %}"></script>
  <script src="{% static "view/dagre-d3/0.1.5/dagre-d3.js" %}"></script>
  <style>
    g.type-TOKEN > rect {
      fill: #00ffd0;
    }

    svg {
      border: 1px solid #999;
      overflow: hidden;
    }

    text {
      font-weight: 300;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
      font-size: 14px;
    }

    .node rect {
      stroke: #999;
      stroke-width: 1px;
      fill: #fff;
    }

    .edgeLabel rect {
      fill: #fff;
    }

    .edgePath path {
      stroke: #333;
      stroke-width: 1.5px;
      fill: none;
    }
  </style>

  <style>
    .highlighted_entity {
      background-color: pink;
    }
    .highlighted_mention {
      background-color: yellow;
    }
   .highlighted_entity.highlighted_mention {
     background-color: pink;
   }
   .mention {
     border-bottom: 3px solid #DDDDDD;
   }
   .section {
     border: 10px solid #DDDDFF;
     padding: 1em;
   }
   .sentence {
     background-color: white;
     margin-top: 0.5em;
     margin-bottom: 0.5em;
   }
   .token {
   }
  </style>

  <script>
   // Hack: Use global variable to keep Communication around in memory
   // TODO: Fix hack
   var global_comm;

   function getTokensForEntityMentionID(comm, mentionId) {
     var entityMention = getEntityMentionWithUUID(comm, mentionId);
     var tokenization = getTokenizationWithUUID(comm, entityMention.tokens.tokenizationId);

     var tokens = new Array();

     for (var tokenIndex in entityMention.tokens.tokenIndexList) {
       tokens.push(tokenization.tokenList[entityMention.tokens.tokenIndexList[tokenIndex]].text);
     }
     return tokens;
   }

   function getEntityMentionWithUUID(comm, uuid) {
     if (comm.entityMentionSets) {
       for (var entityMentionSetIndex in comm.entityMentionSets) {
         if (comm.entityMentionSets[entityMentionSetIndex].mentionSet) {
           for (var mentionSetIndex in comm.entityMentionSets[entityMentionSetIndex].mentionSet) {
             var entityMention = comm.entityMentionSets[entityMentionSetIndex].mentionSet[mentionSetIndex];
             if (entityMention.uuid == uuid) {
               return entityMention;
             }
           }
         }
       }
     }
     // TODO: Error handling if no matching UUID could be found
     console.log("ERROR: No EntityMention found with UUID " + uuid);
   }

   function getTokenizationWithUUID(comm, uuid) {
     if (comm.sectionSegmentations[0].sectionList) {
       for (var sectionListIndex in comm.sectionSegmentations[0].sectionList) {
         if (comm.sectionSegmentations[0].sectionList[sectionListIndex].sentenceSegmentation) {
           for (var sentenceIndex in comm.sectionSegmentations[0].sectionList[sectionListIndex].sentenceSegmentation[0].sentenceList) {
             var sentence = comm.sectionSegmentations[0].sectionList[sectionListIndex].sentenceSegmentation[0].sentenceList[sentenceIndex];
             for (var tokenizationListIndex in sentence.tokenizationList) {
               if (sentence.tokenizationList[tokenizationListIndex].uuid == uuid) {
                 return sentence.tokenizationList[tokenizationListIndex];
               }
             }
           }
         }
       }
     }
     // TODO: Error handling if no matching UUID could be found
     console.log("ERROR: No Tokenization found with UUID " + uuid);
   }

   function cleanedTokenText(tokenText) {
     // Convert Penn Treebank-style symbols for brackets to bracket characters
     //   http://www.cis.upenn.edu/~treebank/tokenization.html
     switch(tokenText) {
       case '-LRB-':
         return '(';
       case '-RRB-':
         return ')';
       case '-LSB-':
         return '[';
       case '-RSB-':
         return ']';
       case '-LCB-':
         return '{';
       case '-RCB-':
         return '}';
       default:
         return tokenText;
     }
   }

   function drawSentenceParse(containerSelectorString, tokenization) {
     var g = new dagreD3.Digraph();

     for (var constituentIndex in tokenization.parse.constituentList) {
       var constituent = tokenization.parse.constituentList[constituentIndex];
       if (constituent.headChildIndex == -1) {
         g.addNode(constituent.id, { label: constituent.tag, nodeclass: "type-TOKEN" });
       }
       else {
         g.addNode(constituent.id, { label: constituent.tag, nodeclass: "type-foo"});
       }
     }

     for (var constituentIndex in tokenization.parse.constituentList) {
       var constituent = tokenization.parse.constituentList[constituentIndex];
       if (constituent.headChildIndex != -1) {
         for (var childIndex in constituent.childList) {
           g.addEdge(null, constituent.id, constituent.childList[childIndex]);
         }
       }
     }

     var renderer = new dagreD3.Renderer();
     var oldDrawNodes = renderer.drawNodes();
     renderer.drawNodes(function(graph, root) {
       var svgNodes = oldDrawNodes(graph, root);
       svgNodes.each(function(u) {
         d3.select(this).classed(graph.node(u).nodeclass, true);
       });
       return svgNodes;
     });
     d3.select(containerSelectorString)
       .append("svg").attr("height", 800).attr("width", 600).attr("style", "background-color: white;")
       .append("g").attr("transform", "translate(20, 20)");
     var layout = renderer.run(g, d3.select(containerSelectorString).select("svg").select("g"));
     d3.select(containerSelectorString).select("svg")
       .attr("width", layout.graph().width + 40)
       .attr("height", layout.graph().height + 40);
   }

   function addSentenceParse(sentenceUUID, tokenizationUUID) {
     var tokenization = getTokenizationWithUUID(global_comm, tokenizationUUID);
     drawSentenceParse("#sentence_parse_" + sentenceUUID, tokenization);
   }

   $(document).ready(function() {
     $.getJSON("{% url 'as_json' %}", function(comm) {
       global_comm = comm;

       // Add tokens to DOM tree
       for (var sectionListIndex in comm.sectionSegmentations[0].sectionList) {
         var section_div = $('<div>').addClass('section')
                                        .attr('id', 'section_' + comm.sectionSegmentations[0].sectionList[sectionListIndex].uuid);
         if (comm.sectionSegmentations[0].sectionList[sectionListIndex].sentenceSegmentation) {
           for (var sentenceIndex in comm.sectionSegmentations[0].sectionList[sectionListIndex].sentenceSegmentation[0].sentenceList) {
             var sentence = comm.sectionSegmentations[0].sectionList[sectionListIndex].sentenceSegmentation[0].sentenceList[sentenceIndex];
             var sentence_div = $('<div>')
                                .addClass('sentence')
                                .attr('id', 'sentence_' + sentence.uuid);
             sentence_div.append($('<button>')
                                 .attr('type', 'button')
                                 .addClass('btn btn-default btn-xs')
                                 .click({ sentence_uuid: sentence.uuid, tokenization_uuid: sentence.tokenizationList[0].uuid}, function(event) {
                                    addSentenceParse(event.data.sentence_uuid, event.data.tokenization_uuid);
                                 })
                                 .css('margin-right', '1em')
                                 .html("Parse Tree"));
             for (var tokenIndex in sentence.tokenizationList[0].tokenList) {
               var token = sentence.tokenizationList[0].tokenList[tokenIndex];
               var token_span = $('<span>')
                                   .addClass('token')
                                   .attr('id', 'tokenization_' + sentence.tokenizationList[0].uuid + "_" + token.tokenIndex)
                                   .html(cleanedTokenText(token.text));
               var token_padding_span = $('<span>')
                                   .addClass('token_padding')
                                   .attr('id', 'tokenization_padding_' + sentence.tokenizationList[0].uuid + "_" + token.tokenIndex)
                                   .html(" ");
               sentence_div.append(token_span);
               sentence_div.append(token_padding_span);
             }
             sentence_div.append($('<div>').attr('id', 'sentence_parse_' + sentence.uuid));
             section_div.append(sentence_div);
           }
         }
         $('#communication').append(section_div);
       }

       // Add mentionId's to tokens
       for (var entityMentionSetIndex in comm.entityMentionSets) {
         if (comm.entityMentionSets[entityMentionSetIndex].mentionSet) {
           for (var mentionSetIndex in comm.entityMentionSets[entityMentionSetIndex].mentionSet) {
             var entityMention = comm.entityMentionSets[entityMentionSetIndex].mentionSet[mentionSetIndex];
             if (entityMention.tokens.tokenIndexList) {
               var total_tokens = entityMention.tokens.tokenIndexList.length;
               for (tokenIndex in entityMention.tokens.tokenIndexList) {
                 $('#tokenization_' + entityMention.tokens.tokenizationId + '_' + entityMention.tokens.tokenIndexList[tokenIndex])
                                                      .addClass('mention')
                                                      .addClass('mention_' + entityMention.uuid);
                 // For multi-word mentions, the spaces between tokens are treated as part of the mention
                 if (tokenIndex < total_tokens-1) {
                   $('#tokenization_padding_' + entityMention.tokens.tokenizationId + '_' + entityMention.tokens.tokenIndexList[tokenIndex])
                                                                                          .addClass('mention')
                                                                                          .addClass('mention_' + entityMention.uuid);
                 }
               }
             }
           }
         }
       }

       // Add list of entities, and list of mentions for each entity, to the DOM
       for (var entityListIndex in comm.entitySets[0].entityList) {
         var entityList = comm.entitySets[0].entityList[entityListIndex];
         var entityList_div = $('<div>')
                              .html('<b>Entity:</b> <span class="entity_' + entityList.uuid + '">' + entityList.uuid + '</span>');
         var mentionId_ul = $('<ul class="list-inline">');

         for (var mentionIdListIndex in entityList.mentionIdList) {
           var mentionId = entityList.mentionIdList[mentionIdListIndex];
           var mentionId_li = $('<li>')
                                     .html('<span class="mention_' + mentionId + '">' + getTokensForEntityMentionID(comm, mentionId).join(" ") + '</span>');
           mentionId_ul.append(mentionId_li);

           // Add 'entity_ENTITY_UUID' class to each mention of that entity
           $('.mention_' + mentionId).addClass('entity_' + entityList.uuid);
         }
         entityList_div.append(mentionId_ul);

         $('#entityList').append(entityList_div);
       }

       // Add mouseover functions for all elements linked to an entity
       for (var entityListIndex in comm.entitySets[0].entityList) {
         var entity = comm.entitySets[0].entityList[entityListIndex];
         $('.entity_' + entity.uuid).mouseenter({ entity_selector: '.entity_' + entity.uuid }, function(event) {
           $(event.data.entity_selector).addClass("highlighted_entity");
         }).mouseleave({ entity_selector: '.entity_' + entity.uuid }, function(event) {
           $(event.data.entity_selector).removeClass("highlighted_entity");
         });
       }

       // Add mouseover functions for all elements linked to a mention
       for (var entityMentionSetIndex in comm.entityMentionSets) {
         for (var mentionSetIndex in comm.entityMentionSets[entityMentionSetIndex].mentionSet) {
           var entityMention = comm.entityMentionSets[entityMentionSetIndex].mentionSet[mentionSetIndex];
           $('.mention_' + entityMention.uuid).mouseenter({ mention_selector: '.mention_'+entityMention.uuid }, function(event) {
             $(event.data.mention_selector).addClass("highlighted_mention");
           }).mouseleave({ mention_selector: '.mention_'+entityMention.uuid }, function(event) {
             $(event.data.mention_selector).removeClass("highlighted_mention");
           });
         }
       }
     });
   });
  </script>
</head>
<body>
  <div class="container">

    <h2>Sentences</h2>
    <div id="communication"></div>

    <h2>Entities</h2>
    <div id="entityList"></div>
  </div>

</body>
</html>
