<!DOCTYPE html>
<html lang="en">
<head>
  <title>Quicklime</title>
  <meta charset='UTF-8'>

  <link rel="stylesheet" href="static/quicklime/bootstrap-3.2.0/css/bootstrap.css"/>
  <link rel="stylesheet" href="static/quicklime/bootstrap-3.2.0/css/bootstrap-theme.css"/>
  <link rel="stylesheet" href="static/quicklime/brat/static/style-vis.css"/>
  <link rel="stylesheet" href="static/quicklime/quicklime.css"/>

  <script src="static/quicklime/jquery-1.11.1.min.js"></script>
  <script src="static/quicklime/underscore-1.7.0.min.js"></script>
  <script src="static/quicklime/bootstrap-3.2.0/js/bootstrap.js"></script>
  <script src="static/quicklime/d3/3.4.4/d3.js"></script>
  <script src="static/quicklime/dagre-d3/0.2.9/dagre-d3.js"></script>
  <script src="static/quicklime/jquery.splitter.js"></script>

  <!-- === BRAT SCRIPTS === -->
  <!-- SVG for jQuery: http://keith-wood.name/svg.html

       BRAT comes bundled with v1.4.3 of SVG for jQuery, which is incompatible
       with jQuery v1.7.2 and later.  We are using the jQuery SVG files from
       a fork of the project:
         https://github.com/twitwi/svg

       This fork is compatible with jQuery 1.8+, but not jQuery 1.7.
  -->
  <script src="static/quicklime/jquery.svg.js"></script>
  <script src="static/quicklime/jquery.svgdom.js"></script>

  <!-- BRAT helper modules -->
  <script src="static/quicklime/brat/client/src/configuration.js"></script>
  <script src="static/quicklime/brat/client/src/util.js"></script>
  <script src="static/quicklime/brat/client/src/annotation_log.js"></script>

  <!-- BRAT modules -->
  <script src="static/quicklime/brat/client/src/dispatcher.js"></script>
  <script src="static/quicklime/brat/client/src/url_monitor.js"></script>
  <script src="static/quicklime/brat/client/src/visualizer.js"></script>
  <!-- === /BRAT SCRIPTS === -->

  <script src="static/quicklime/quicklime.js"></script>
  <script src="static/quicklime/quicklime.brat.js"></script>
  <script src="static/quicklime/quicklime.parse.js"></script>

  <script src="static/quicklime/thrift.js"></script>
  <script src="static/quicklime/concrete.js"></script>

  <script>
    // Copied from:
    //   http://stackoverflow.com/questions/19491336/get-url-parameter-jquery-or-how-to-get-query-string-values-in-js
    function getUrlParameter(sParam) {
      var sPageURL = decodeURIComponent(window.location.search.substring(1)),
          sURLVariables = sPageURL.split('&'),
          sParameterName,
          i;

      for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
          return sParameterName[1] === undefined ? true : sParameterName[1];
        }
      }
    };

    $(document).ready(function() {
      $("#toggle_controls").click(function(event) {
        var id = $(event.target).find('input').attr('id');
        if (id === "show_controls") {
          $('.tokenization_controls').show();
        }
        else if (id === "hide_controls") {
          $('.tokenization_controls').hide();
        }
      });

      $('#splitter').splitter({
        resizeTo: window,
        sizeTop: true,
        splitHorizontal: true
      });

      function renderCommunication(comm) {
        comm.addInternalReferences();

        $('#communication_one').empty();
        $('#entityTable').empty();

        QL.addCommunication('communication_one', comm,
                            showTokenizationControls=$('#show_controls').prop('checked'));
        QL.parse.addTokenizationParseControls(comm);
        QL.brat.addTokenizationBRATControls(comm);
        QL.addEntityTable('entityTable', comm);
        // QL.addSituationMentionTable('situationMentionTable', comm);
        // QL.addMouseoverHighlightingForAllEntitySets(comm);
      }

      function fetchCommunication(commID) {
        var fetchRequest = new FetchRequest({communicationIds: [commID]});
        var fetchResult = fetchClient.fetch(fetchRequest);
        var comm = fetchResult.communications[0];
        return comm;
      }

      var transport = new Thrift.Transport("/quicklime/fetch_http_endpoint/");
      var protocol = new Thrift.TJSONProtocol(transport);
      var fetchClient = new FetchCommunicationServiceClient(protocol);

      var getID = getUrlParameter('id');

      if (getID) {
        var comm = fetchCommunication(getID);
        renderCommunication(comm);
      }
      else {
        var totalCommunications = fetchClient.getCommunicationCount();
        if (totalCommunications === 0) {
          // TODO: Display error message to user
        }
        else if (totalCommunications === 1) {
          var communicationIDs = fetchClient.getCommunicationIDs(0,1);
          var comm = fetchCommunication(communicationIDs[0]);
          renderCommunication(comm);
        }
        else {
          // Display a list of Communication IDs, instead of displaying the actual Communication

          function appendCommunicationIDs(communicationIDs) {
            for (var i = 0; i < communicationIDs.length; i++) {
              $('#communication_id_list').append(
                $('<span>').css('display', 'inline-block')
                           .css('padding', '0.5em')
                           .append(
                             $('<a>').attr('href', '?id='+communicationIDs[i])
                                     .text(communicationIDs[i])));
            }
          }

          function conditionallyAppendLoadButton(commOffset, commCount, totalCommunications) {
            if (commOffset+commCount < totalCommunications) {
              $('#communication_id_list').append(
                $('<button>').addClass('btn btn-default btn-xs')
                             .text('LOAD MORE')
                             .click(
                               { commOffset: commCount+commOffset, commCount: commCount},
                               function(event) {
                                 var communicationIDs = fetchClient.getCommunicationIDs(
                                   event.data.commOffset, event.data.commCount);
                                 appendCommunicationIDs(communicationIDs);
                                 conditionallyAppendLoadButton(commOffset+commCount, commCount, totalCommunications);
                                 $(this).remove();
                               }));
            }
          }

          var commCount = getUrlParameter('commCount');
          var commOffset = getUrlParameter('commOffset');
          if (!commCount) {
            commCount = 50;
          }
          if (!commOffset) {
            commOffset = 0;
          }

          var communicationIDs = fetchClient.getCommunicationIDs(commOffset, commCount);
          appendCommunicationIDs(communicationIDs);
          conditionallyAppendLoadButton(commOffset, commCount, totalCommunications);
        }
      }
    });
  </script>
  <style>
    html, body {
      margin: 0px;
      padding: 0px;
      overflow: hidden;
    }
    body {
      padding-top: 50px;
    }
    .splitter-pane {
      overflow: auto;
    }
    div.splitter-bar-horizontal {
      height: 3px;
      background: #444444;
    }
    #splitter {
      height: 300px;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
      <div class="btn-group" data-toggle="buttons" id="toggle_controls">
        <label class="btn btn-default active">
          <input type="radio" name="toggle_controls" id="show_controls" checked> Show Controls
        </label>
        <label class="btn btn-default">
          <input type="radio" name="toggle_controls" id="hide_controls"> Hide Controls
        </label>
      </div>
    </div>
  </nav>

  <div id="splitter">
    <div style="height: 400px; min-height: 150px;">
      <div class="container-fluid">
        <div id="communication_id_list"></div>
        <div id="communication_one"></div>
      </div>
    </div>
    <div style="margin-top: 0.5em;">
      <div class="container-fluid">

        <div class="panel-group">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                <a data-toggle="collapse" href="#collapseEntities">
                  Entities
                </a>
              </h4>
            </div>
            <div id="collapseEntities" class="panel-collapse collapse in">
              <div class="panel-body">
                <div id="entityTable"></div>
              </div>
            </div>
          </div>
          <!--
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                <a data-toggle="collapse" href="#collapseSituationMentions">
                  Situation Mentions
                </a>
              </h4>
            </div>
            <div id="collapseSituationMentions" class="panel-collapse collapse in">
              <div class="panel-body">
                <div id="situationMentionTable"></div>
              </div>
            </div>
          </div>
          -->
        </div>
      </div>
    </div>
  </div><!-- #splitter -->

</body>
</html>
